<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pbad.announcement.mapper.AnnouncementMapper">

    <resultMap id="AnnouncementResultMap" type="com.pbad.announcement.domain.po.AnnouncementPO">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="richContent" column="rich_content"/>
        <result property="link" column="link"/>
        <result property="type" column="type"/>
        <result property="priority" column="priority"/>
        <result property="status" column="status"/>
        <result property="pushStrategy" column="push_strategy"/>
        <result property="requireConfirm" column="require_confirm"/>
        <result property="effectiveTime" column="effective_time"/>
        <result property="expireTime" column="expire_time"/>
        <result property="scheduledTime" column="scheduled_time"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, title, content, rich_content, link, type, priority, status, push_strategy,
        require_confirm, effective_time, expire_time, scheduled_time, created_at, updated_at
    </sql>

    <insert id="insert" parameterType="com.pbad.announcement.domain.po.AnnouncementPO">
        INSERT INTO announcement (
            id, title, content, rich_content, link, type, priority, status, push_strategy,
            require_confirm, effective_time, expire_time, scheduled_time, created_at, updated_at
        ) VALUES (
            #{id}, #{title}, #{content}, #{richContent}, #{link}, #{type},
            IFNULL(#{priority}, 0), #{status}, #{pushStrategy},
            IFNULL(#{requireConfirm}, 0), #{effectiveTime}, #{expireTime}, #{scheduledTime},
            IFNULL(#{createdAt}, NOW()), IFNULL(#{updatedAt}, NOW())
        )
    </insert>

    <update id="update" parameterType="com.pbad.announcement.domain.po.AnnouncementPO">
        UPDATE announcement
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="content != null">content = #{content},</if>
            <if test="richContent != null">rich_content = #{richContent},</if>
            <if test="link != null">link = #{link},</if>
            <if test="type != null">type = #{type},</if>
            <if test="priority != null">priority = #{priority},</if>
            <if test="status != null">status = #{status},</if>
            <if test="pushStrategy != null">push_strategy = #{pushStrategy},</if>
            <if test="requireConfirm != null">require_confirm = #{requireConfirm},</if>
            <if test="effectiveTime != null">effective_time = #{effectiveTime},</if>
            <if test="expireTime != null">expire_time = #{expireTime},</if>
            <if test="scheduledTime != null">scheduled_time = #{scheduledTime},</if>
            updated_at = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM announcement WHERE id = #{id}
    </delete>

    <select id="selectById" resultMap="AnnouncementResultMap">
        SELECT
            <include refid="Base_Column_List"/>
        FROM announcement
        WHERE id = #{id}
    </select>

    <select id="selectPage" resultMap="AnnouncementResultMap">
        SELECT
            <include refid="Base_Column_List"/>
        FROM announcement
        <where>
            <if test="status != null and status != ''">
                status = #{status}
            </if>
        </where>
        ORDER BY priority DESC, created_at DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="count" resultType="long">
        SELECT COUNT(1)
        FROM announcement
        <where>
            <if test="status != null and status != ''">
                status = #{status}
            </if>
        </where>
    </select>

    <select id="selectUnreadByUser" resultMap="AnnouncementResultMap">
        SELECT
            a.id, a.title, a.content, a.rich_content, a.link, a.type, a.priority,
            a.status, a.push_strategy, a.require_confirm, a.effective_time, a.expire_time,
            a.scheduled_time, a.created_at, a.updated_at
        FROM announcement a
        LEFT JOIN announcement_read ar ON a.id = ar.announcement_id AND ar.user_id = #{userId}
        WHERE a.status = 'PUBLISHED'
          AND ar.id IS NULL
          AND (a.effective_time IS NULL OR a.effective_time &lt;= NOW())
          AND (a.expire_time IS NULL OR a.expire_time &gt;= NOW())
        ORDER BY a.priority DESC, a.created_at DESC
    </select>

    <select id="selectActiveAnnouncements" resultMap="AnnouncementResultMap">
        SELECT
            <include refid="Base_Column_List"/>
        FROM announcement
        WHERE status = 'PUBLISHED'
          AND (effective_time IS NULL OR effective_time &lt;= NOW())
          AND (expire_time IS NULL OR expire_time &gt;= NOW())
        ORDER BY priority DESC, created_at DESC
    </select>

</mapper>

