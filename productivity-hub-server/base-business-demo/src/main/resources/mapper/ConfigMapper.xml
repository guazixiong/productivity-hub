<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pbad.config.mapper.ConfigMapper">

    <resultMap id="BaseResultMap" type="com.pbad.config.domain.po.ConfigItemPO">
        <id column="id" property="id" jdbcType="VARCHAR"/>
        <result column="module" property="module" jdbcType="VARCHAR"/>
        <result column="config_key" property="configKey" jdbcType="VARCHAR"/>
        <result column="config_value" property="configValue" jdbcType="VARCHAR"/>
        <result column="description" property="description" jdbcType="VARCHAR"/>
        <result column="created_at" property="createdAt" jdbcType="VARCHAR"/>
        <result column="updated_at" property="updatedAt" jdbcType="VARCHAR"/>
        <result column="updated_by" property="updatedBy" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, module, config_key, config_value, description, created_at, updated_at, updated_by
    </sql>

    <!-- 查询所有配置项 -->
    <select id="selectAll" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_config
        ORDER BY module, config_key
    </select>

    <!-- 根据ID查询配置项 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_config
        WHERE id = #{id}
    </select>

    <!-- 根据模块与配置键查询配置项 -->
    <select id="selectByModuleAndKey" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_config
        WHERE module = #{module}
          AND config_key = #{configKey}
    </select>

    <!-- 更新配置项 -->
    <update id="updateConfig">
        UPDATE sys_config
        SET config_value = #{configValue},
            <if test="description != null and description != ''">
                description = #{description},
            </if>
            updated_at = DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i'),
            updated_by = #{updatedBy}
        WHERE id = #{id}
    </update>

    <!-- 插入配置项 -->
    <insert id="insertConfig">
        INSERT INTO sys_config (id, module, config_key, config_value, description, created_at, updated_at, updated_by)
        VALUES (#{id}, #{module}, #{configKey}, #{configValue}, #{description}, 
                DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i'), 
                DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i'), 
                #{updatedBy})
    </insert>

</mapper>

