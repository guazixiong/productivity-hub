<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pbad.bookmark.mapper.BookmarkUrlTagMapper">

    <resultMap id="BookmarkUrlTagResultMap" type="com.pbad.bookmark.domain.po.BookmarkUrlTagPO">
        <id property="id" column="id"/>
        <result property="urlId" column="url_id"/>
        <result property="tagId" column="tag_id"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 根据网址ID查询关联的标签ID列表（按用户ID过滤） -->
    <select id="selectTagIdsByUrlId" resultType="string">
        SELECT ut.tag_id
        FROM bookmark_url_tag ut
        INNER JOIN bookmark_url u ON ut.url_id = u.id
        WHERE ut.url_id = #{urlId}
            AND u.user_id = #{userId}
        ORDER BY ut.created_at DESC
    </select>

    <!-- 根据标签ID查询关联的网址ID列表（按用户ID过滤） -->
    <select id="selectUrlIdsByTagId" resultType="string">
        SELECT ut.url_id
        FROM bookmark_url_tag ut
        INNER JOIN bookmark_url u ON ut.url_id = u.id
        WHERE ut.tag_id = #{tagId}
            AND u.user_id = #{userId}
        ORDER BY ut.created_at DESC
    </select>

    <!-- 插入关联关系 -->
    <insert id="insertUrlTag" parameterType="com.pbad.bookmark.domain.po.BookmarkUrlTagPO">
        INSERT INTO bookmark_url_tag (
            id,
            url_id,
            tag_id,
            created_at
        ) VALUES (
            #{id},
            #{urlId},
            #{tagId},
            IFNULL(#{createdAt}, NOW())
        )
    </insert>

    <!-- 删除单条关联关系 -->
    <delete id="deleteUrlTag">
        DELETE FROM bookmark_url_tag
        WHERE url_id = #{urlId}
          AND tag_id = #{tagId}
    </delete>

    <!-- 根据网址ID删除所有关联关系 -->
    <delete id="deleteByUrlId" parameterType="string">
        DELETE FROM bookmark_url_tag WHERE url_id = #{urlId}
    </delete>

    <!-- 根据标签ID删除所有关联关系 -->
    <delete id="deleteByTagId" parameterType="string">
        DELETE FROM bookmark_url_tag WHERE tag_id = #{tagId}
    </delete>

    <!-- 批量插入关联关系 -->
    <insert id="batchInsertUrlTags" parameterType="java.util.List">
        INSERT INTO bookmark_url_tag (id, url_id, tag_id, created_at)
        VALUES
        <foreach collection="urlTags" item="item" separator=",">
            (#{item.id}, #{item.urlId}, #{item.tagId}, IFNULL(#{item.createdAt}, NOW()))
        </foreach>
    </insert>

    <!-- 批量删除关联关系 -->
    <delete id="batchDeleteUrlTags">
        DELETE FROM bookmark_url_tag
        WHERE url_id = #{urlId}
          AND tag_id IN
          <foreach collection="tagIds" item="tagId" open="(" close=")" separator=",">
              #{tagId}
          </foreach>
    </delete>

</mapper>


