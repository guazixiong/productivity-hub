<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pbad.acl.mapper.AclMenuMapper">

    <resultMap id="AclMenuResultMap" type="com.pbad.acl.domain.po.AclMenuPO">
        <id property="id" column="id"/>
        <result property="parentId" column="parent_id"/>
        <result property="name" column="name"/>
        <result property="path" column="path"/>
        <result property="component" column="component"/>
        <result property="icon" column="icon"/>
        <result property="type" column="type"/>
        <result property="visible" column="visible"/>
        <result property="orderNum" column="order_num"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, parent_id, name, path, component, icon, type, visible, order_num, status, created_at, updated_at
    </sql>

    <!-- 查询所有菜单 -->
    <select id="selectAll" resultMap="AclMenuResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM acl_menu
        ORDER BY order_num ASC, created_at ASC
    </select>

    <!-- 根据ID查询菜单 -->
    <select id="selectById" resultMap="AclMenuResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM acl_menu
        WHERE id = #{id}
    </select>

    <!-- 根据父菜单ID查询子菜单列表 -->
    <select id="selectByParentId" resultMap="AclMenuResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM acl_menu
        WHERE parent_id = #{parentId}
        ORDER BY order_num ASC, created_at ASC
    </select>

    <!-- 查询所有菜单（树形结构，按orderNum排序） -->
    <select id="selectAllForTree" resultMap="AclMenuResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM acl_menu
        WHERE status = 'ENABLED'
        <if test="includeHidden == null or includeHidden == false">
            AND visible = 1
        </if>
        ORDER BY order_num ASC, created_at ASC
    </select>

    <!-- 插入菜单 -->
    <insert id="insertMenu" parameterType="com.pbad.acl.domain.po.AclMenuPO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO acl_menu (
            parent_id,
            name,
            path,
            component,
            icon,
            type,
            visible,
            order_num,
            status,
            created_at,
            updated_at
        ) VALUES (
            #{parentId},
            #{name},
            #{path},
            #{component},
            #{icon},
            #{type},
            #{visible},
            #{orderNum},
            #{status},
            IFNULL(#{createdAt}, NOW()),
            IFNULL(#{updatedAt}, NOW())
        )
    </insert>

    <!-- 更新菜单 -->
    <update id="updateMenu" parameterType="com.pbad.acl.domain.po.AclMenuPO">
        UPDATE acl_menu
        SET
            parent_id = #{parentId},
            name = #{name},
            path = #{path},
            component = #{component},
            icon = #{icon},
            type = #{type},
            visible = #{visible},
            order_num = #{orderNum},
            status = #{status},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- 删除菜单 -->
    <delete id="deleteMenu">
        DELETE FROM acl_menu
        WHERE id = #{id}
    </delete>

    <!-- 检查菜单是否被角色占用 -->
    <select id="countRoleMenuByMenuId" resultType="int">
        SELECT COUNT(*)
        FROM acl_role_menu
        WHERE menu_id = #{menuId}
    </select>

    <!-- 计算菜单层级深度（兼容 MySQL 5.7 及以下版本，假设最大层级不超过10层） -->
    <select id="calculateMenuLevel" resultType="int">
        SELECT 
            CASE 
                WHEN m10.id IS NOT NULL THEN 10
                WHEN m9.id IS NOT NULL THEN 9
                WHEN m8.id IS NOT NULL THEN 8
                WHEN m7.id IS NOT NULL THEN 7
                WHEN m6.id IS NOT NULL THEN 6
                WHEN m5.id IS NOT NULL THEN 5
                WHEN m4.id IS NOT NULL THEN 4
                WHEN m3.id IS NOT NULL THEN 3
                WHEN m2.id IS NOT NULL THEN 2
                ELSE 1
            END AS level
        FROM acl_menu m1
        LEFT JOIN acl_menu m2 ON m1.parent_id = m2.id
        LEFT JOIN acl_menu m3 ON m2.parent_id = m3.id
        LEFT JOIN acl_menu m4 ON m3.parent_id = m4.id
        LEFT JOIN acl_menu m5 ON m4.parent_id = m5.id
        LEFT JOIN acl_menu m6 ON m5.parent_id = m6.id
        LEFT JOIN acl_menu m7 ON m6.parent_id = m7.id
        LEFT JOIN acl_menu m8 ON m7.parent_id = m8.id
        LEFT JOIN acl_menu m9 ON m8.parent_id = m9.id
        LEFT JOIN acl_menu m10 ON m9.parent_id = m10.id
        WHERE m1.id = #{id}
    </select>

    <!-- 检查是否存在循环引用（兼容 MySQL 5.7 及以下版本，假设最大层级不超过10层） -->
    <select id="checkCircularReference" resultType="int">
        SELECT COUNT(*)
        FROM (
            SELECT m1.id
            FROM acl_menu m1
            WHERE m1.id = #{parentId}
            UNION
            SELECT m2.id
            FROM acl_menu m1
            INNER JOIN acl_menu m2 ON m1.parent_id = m2.id
            WHERE m1.id = #{parentId}
            UNION
            SELECT m3.id
            FROM acl_menu m1
            INNER JOIN acl_menu m2 ON m1.parent_id = m2.id
            INNER JOIN acl_menu m3 ON m2.parent_id = m3.id
            WHERE m1.id = #{parentId}
            UNION
            SELECT m4.id
            FROM acl_menu m1
            INNER JOIN acl_menu m2 ON m1.parent_id = m2.id
            INNER JOIN acl_menu m3 ON m2.parent_id = m3.id
            INNER JOIN acl_menu m4 ON m3.parent_id = m4.id
            WHERE m1.id = #{parentId}
            UNION
            SELECT m5.id
            FROM acl_menu m1
            INNER JOIN acl_menu m2 ON m1.parent_id = m2.id
            INNER JOIN acl_menu m3 ON m2.parent_id = m3.id
            INNER JOIN acl_menu m4 ON m3.parent_id = m4.id
            INNER JOIN acl_menu m5 ON m4.parent_id = m5.id
            WHERE m1.id = #{parentId}
            UNION
            SELECT m6.id
            FROM acl_menu m1
            INNER JOIN acl_menu m2 ON m1.parent_id = m2.id
            INNER JOIN acl_menu m3 ON m2.parent_id = m3.id
            INNER JOIN acl_menu m4 ON m3.parent_id = m4.id
            INNER JOIN acl_menu m5 ON m4.parent_id = m5.id
            INNER JOIN acl_menu m6 ON m5.parent_id = m6.id
            WHERE m1.id = #{parentId}
            UNION
            SELECT m7.id
            FROM acl_menu m1
            INNER JOIN acl_menu m2 ON m1.parent_id = m2.id
            INNER JOIN acl_menu m3 ON m2.parent_id = m3.id
            INNER JOIN acl_menu m4 ON m3.parent_id = m4.id
            INNER JOIN acl_menu m5 ON m4.parent_id = m5.id
            INNER JOIN acl_menu m6 ON m5.parent_id = m6.id
            INNER JOIN acl_menu m7 ON m6.parent_id = m7.id
            WHERE m1.id = #{parentId}
            UNION
            SELECT m8.id
            FROM acl_menu m1
            INNER JOIN acl_menu m2 ON m1.parent_id = m2.id
            INNER JOIN acl_menu m3 ON m2.parent_id = m3.id
            INNER JOIN acl_menu m4 ON m3.parent_id = m4.id
            INNER JOIN acl_menu m5 ON m4.parent_id = m5.id
            INNER JOIN acl_menu m6 ON m5.parent_id = m6.id
            INNER JOIN acl_menu m7 ON m6.parent_id = m7.id
            INNER JOIN acl_menu m8 ON m7.parent_id = m8.id
            WHERE m1.id = #{parentId}
            UNION
            SELECT m9.id
            FROM acl_menu m1
            INNER JOIN acl_menu m2 ON m1.parent_id = m2.id
            INNER JOIN acl_menu m3 ON m2.parent_id = m3.id
            INNER JOIN acl_menu m4 ON m3.parent_id = m4.id
            INNER JOIN acl_menu m5 ON m4.parent_id = m5.id
            INNER JOIN acl_menu m6 ON m5.parent_id = m6.id
            INNER JOIN acl_menu m7 ON m6.parent_id = m7.id
            INNER JOIN acl_menu m8 ON m7.parent_id = m8.id
            INNER JOIN acl_menu m9 ON m8.parent_id = m9.id
            WHERE m1.id = #{parentId}
            UNION
            SELECT m10.id
            FROM acl_menu m1
            INNER JOIN acl_menu m2 ON m1.parent_id = m2.id
            INNER JOIN acl_menu m3 ON m2.parent_id = m3.id
            INNER JOIN acl_menu m4 ON m3.parent_id = m4.id
            INNER JOIN acl_menu m5 ON m4.parent_id = m5.id
            INNER JOIN acl_menu m6 ON m5.parent_id = m6.id
            INNER JOIN acl_menu m7 ON m6.parent_id = m7.id
            INNER JOIN acl_menu m8 ON m7.parent_id = m8.id
            INNER JOIN acl_menu m9 ON m8.parent_id = m9.id
            INNER JOIN acl_menu m10 ON m9.parent_id = m10.id
            WHERE m1.id = #{parentId}
        ) AS ancestors
        WHERE id = #{id}
    </select>

    <!-- 根据菜单ID列表查询菜单 -->
    <select id="selectByIds" resultMap="AclMenuResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM acl_menu
        WHERE id IN
        <foreach collection="menuIds" item="menuId" open="(" separator="," close=")">
            #{menuId}
        </foreach>
        ORDER BY order_num ASC
    </select>

</mapper>

